## 实验六：流体仿真算法实现

2311136 崔颖欣

#### 一、实验目的与内容

熟悉基于粒子的拉格朗日流体仿真的基本流程；在给定框架中实现 2D 粒子系统的核心模块：粒子生成、邻域搜索、物理量计算与时间积分；搭建“向上喷射的喷泉”场景，验证粒子系统在外力、边界约束与持续注入条件下的稳定性与可视化效果。  


#### 二、实验原理简述

在实现时我使用了 SPH 的思路：对每个粒子，只在其支撑半径的邻域内，用核函数对周围粒子做加权求和来估计密度；密度再通过状态方程转换为压强。得到压强后，再根据压强梯度项和粘性项计算粒子间的相互作用力，并叠加重力得到加速度。随后使用显式欧拉积分更新粒子的速度与位置，同时对速度做上限约束来提高稳定性。

边界处理方面，粒子与容器边界发生碰撞时采用“位置钳制 + 速度反弹衰减”的方式把越界粒子推回边界内，并将对应方向速度反向并乘以衰减系数，从而避免粒子穿透并减少数值震荡。

为了提升效率，框架把容器划分为若干网格块（block），粒子根据 blockId 分桶后，邻域搜索只需要访问自身 block 及周围相邻的 block，这样可以把计算量从全局两两遍历的 $$O(n^2)$$ 降到局部访问为主的开销。

（参考[基于Python的Sph粒子算法实现及其在流体模拟中的应用解析 - 云原生实践](https://www.oryoy.com/news/ji-yu-python-de-sph-li-zi-suan-fa-shi-xian-ji-qi-zai-liu-ti-mo-ni-zhong-de-ying-yong-jie-xi.html)、https://blog.csdn.net/liuyunduo/article/details/84098884与https://blog.csdn.net/qq_39300235/article/details/100981656）


#### 三、实验内容与实现步骤

##### （1）原有代码框架梳理

![代码框架](D:\course5\graphics-lab6\代码框架.jpg)

（最后一块写错了，没有删除粒子）

##### （2）核心模块实现（Particle System）

本实验在既有框架接口基础上补全了 Particle System 与 SPH 求解流程。粒子状态使用框架提供的 `ParticleInfo2d` 结构体保存，其中包含位置、速度、加速度、密度与压强等信息。初始化阶段通过 `ParticleSystem2d::addFluidBlock()` 在用户指定的矩形区域内按粒子间距采样生成粒子，并对采样位置加入少量随机扰动，避免完全规则排列带来的数值伪影。

在空间组织上，`ParticleSystem2d::setContainerSize()` 会根据支撑半径将容器划分为二维 block 网格，并据此确定粒子所属的 blockId。每次模拟子步开始前调用 `ParticleSystem2d::updateBlockInfo()` 将粒子按 blockId 排序，并记录每个 block 内粒子在数组中的索引范围。

![img_v3_02t9_4d5c966f-937f-44c7-aac2-614830f42d4g](D:\course5\graphics-lab6\代码框架-改后.jpg)

求解器部分在每个子步中按“更新 block 信息 → 计算密度 → 计算压强 → 计算力与加速度 → 时间积分 → 边界处理 → 更新 blockId”的顺序推进仿真，并在积分阶段加入最大速度限制增强稳定性。

#### 四、实验结果与分析

**本实验的喷泉场景主要由四部分组成：底部水池用于提供初始粒子，喷口负责持续向上“注入”动量，重力让粒子在上升后回落形成循环，而容器边界保证粒子不会无限扩散到视野外。**我在求解器中定义了位于容器底部中心的小矩形喷口区域，当粒子进入该区域时会将其竖直速度提升到一个向上阈值，在调参过程中我发现喷泉形态对时间步长和物理参数比较敏感，最终结果如下图：

<table style="width:100%;">  <tr>     
    <td style="width:25%;">       
    <img src="D:\course5\graphics-lab6\结果pic\1.jpg" width="100%;" />  
    </td>     <td style="width:25%;">       
    <img src="D:\course5\graphics-lab6\结果pic\2.jpg" width="100%;" />  </td>
    <td style="width:25%;">       
    <img src="D:\course5\graphics-lab6\结果pic\3.jpg" width="100%;" />  
        <td style="width:25%;">       
    <img src="D:\course5\graphics-lab6\结果pic\4.jpg" width="100%;" />  </td>

粒子会从喷口区域持续向上喷射，随后在重力作用下逐渐回落，并与底部水池区域形成循环流动。颜色显示的密度分布在喷口附近以及回落汇聚的区域更高，而在喷散较稀疏的位置相对更低；


<table style="width:100%;">  <tr>     
    <td style="width:25%;">       
    <img src="D:\course5\graphics-lab6\结果pic\5.jpg" width="100%;" />  
    </td>     <td style="width:25%;">       
    <img src="D:\course5\graphics-lab6\结果pic\6.jpg" width="100%;" />  </td>
    <td style="width:25%;">       
    <img src="D:\course5\graphics-lab6\结果pic\8.jpg" width="100%;" />  
        <td style="width:25%;">       
    <img src="D:\course5\graphics-lab6\结果pic\7.jpg" width="100%;" />  </td>
**在连续运行过程中还可以看到，喷泉形态会逐渐变得不完全对称，喷射高度也有上升趋势，粒子分布逐渐变得不均匀**。这一方面与喷口持续注入动量有关，另一方面也反映了显式积分和参数选择带来的累积误差。

#### 五、实验总结

通过本次实验，我在给定框架的基础上完成了 2D 粒子流体仿真的核心流程，实现了粒子生成、空间划分的邻域搜索、基于 SPH 思路的密度与受力计算，并使用显式欧拉推进粒子运动，最终搭建出一个能够持续向上喷射并回落循环的喷泉场景。

实验也暴露了一些局限性，例如显式积分容易产生振荡，喷泉形态可能逐渐不对称。后续还可以尝试加入更稳定的时间积分方式或改进的 SPH 稳定化策略等等，使场景更接近真实喷泉的连续流动效果。

